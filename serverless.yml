service: bluesky-feeds

provider:
  name: aws
  region: us-west-2
  runtime: nodejs18.x
  stage: ${opt:stage, 'development'}
  timeout: 28
  memorySize: 1024
  deploymentBucket:
    name: ${ssm:deployment-artifacts-bucket}
  environment:
    PUBLIC_HOSTNAME: ${self:custom.customDomain.domainName}
    SYNC_SUBSCRIBER_QUEUE_TABLE: ${self:custom.syncSubscriberQueueTable}
    SUBSCRIBER_FOLLOWING_TABLE: ${self:custom.subscriberFollowingTable}
    MUTE_WORDS_TABLE: ${self:custom.muteWordsTable}
    BLUESKY_SERVICE_USER_DID: ${ssm:/bluesky-feeds/${self:provider.stage}/service/user-did}
    BLUESKY_FOLLOWING_LIST: ${ssm:/bluesky-feeds/${self:provider.stage}/following-list}


custom:
  prune:
    automatic: true
    number: 3
  serverless-iam-roles-per-function:
    defaultInherit: true
  customDomain:
    domainName: ${ssm:/bluesky-feeds/${self:provider.stage}/domain-name}
    certificateArn: ${ssm:/bluesky-feeds/${self:provider.stage}/certificate-arn}
    endpointType: REGIONAL
    securityPolicy: tls_1_2
    apiType: http
  syncSubscriberQueueTable: ${self:service}-${self:provider.stage}-sync-subscriber-queue
  subscriberFollowingTable: ${self:service}-${self:provider.stage}-subscriber-following
  muteWordsTable: ${self:service}-${self:provider.stage}-mute-words
  updateFollowingQueue: ${self:service}-${self:provider.stage}-update-following
  updateFollowingBackoffQueue: ${self:service}-${self:provider.stage}-update-following-backoff
  updateFollowingQueueDLQ: ${self:service}-${self:provider.stage}-update-following-dlq
  blueskyAuth:
    identifier: ${ssm:/bluesky-feeds/${self:provider.stage}/service/identifier}
    password: ${ssm:/bluesky-feeds/${self:provider.stage}/service/password}

	
plugins:
  - serverless-plugin-typescript
  - serverless-domain-manager
  - serverless-iam-roles-per-function
  - serverless-prune-plugin

functions:
  did:
    handler: ./src/endpoints/did/index.handler
    events:
     - httpApi: GET /.well-known/did.json

  getFeedSkeleton:
    handler: ./src/endpoints/getFeedSkeleton/index.handler
    events:
     - httpApi: GET /xrpc/app.bsky.feed.getFeedSkeleton
    environment:
      BLUESKY_SERVICE_IDENTIFIER: ${self:custom.blueskyAuth.identifier}
      BLUESKY_SERVICE_PASSWORD: ${self:custom.blueskyAuth.password}
    iamRoleStatements:
      - Effect: "Allow"
        Action:
          - dynamodb:GetItem
        Resource:
          - !GetAtt SubscriberFollowingTable.Arn
      - Effect: "Allow"
        Action:
          - dynamodb:Query
        Resource:
          - !GetAtt MuteWordsTable.Arn
      - Effect: "Allow"
        Action:
          - dynamodb:PutItem
        Resource:
          - !GetAtt SyncSubscriberQueueTable.Arn

  notificationListener:
    handler: ./src/endpoints/notificationListener/index.handler
    events:
      - schedule: rate(1 minute)
    environment:
      BLUESKY_SERVICE_IDENTIFIER: ${self:custom.blueskyAuth.identifier}
      BLUESKY_SERVICE_PASSWORD: ${self:custom.blueskyAuth.password}
    iamRoleStatements:
      - Effect: "Allow"
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:DeleteItem
        Resource:
          - !GetAtt MuteWordsTable.Arn
      - Effect: "Allow"
        Action:
          - dynamodb:PutItem
        Resource:
          - !GetAtt SyncSubscriberQueueTable.Arn

  syncSubscriberFollowing:
    handler: ./src/endpoints/syncSubscriberFollowing/index.handler
    events:	
      - stream:
          type: dynamodb
          arn:
            Fn::GetAtt: [SyncSubscriberQueueTable, StreamArn]
          startingPosition: LATEST
          batchSize: 1
          maximumRetryAttempts: 5
          filterPatterns:
            - eventName: [INSERT, MODIFY]
    environment:
      BLUESKY_SERVICE_IDENTIFIER: ${self:custom.blueskyAuth.identifier}
      BLUESKY_SERVICE_PASSWORD: ${self:custom.blueskyAuth.password}
    iamRoleStatements:
      - Effect: "Allow"
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource:
          - !GetAtt SyncSubscriberQueueTable.Arn
          - !GetAtt SubscriberFollowingTable.Arn

  syncSubscriberFollowing-trigUpdFoll:
    handler: ./src/endpoints/syncSubscriberFollowing/triggerUpdateFollowing.handler
    events:
      - sqs:
          arn:
            Fn::GetAtt: [UpdateFollowingBackoffQueue, Arn]
          batchSize: 1
          maximumConcurrency: 2
      - stream:
          type: dynamodb
          arn:
            Fn::GetAtt: [SubscriberFollowingTable, StreamArn]
          startingPosition: LATEST
          batchSize: 1
          maximumRetryAttempts: 5
          filterPatterns:
            - eventName: [INSERT]
              dynamodb: 
                NewImage:
                  subscriberDid:
                    S: [aggregate]
            - eventName: [MODIFY]
              dynamodb: 
                NewImage:
                  subscriberDid:
                    S: [aggregate]
                  followedBy:
                    N: ["0"]
    environment:
      UPDATE_FOLLOWING_QUEUE_URL: !Ref UpdateFollowingQueue
      UPDATE_FOLLOWING_BACKOFF_QUEUE_URL: !Ref UpdateFollowingBackoffQueue
    iamRoleStatementsName: ${self:service}-${self:provider.stage}-syncSubscriber-trigfoll-${self:provider.region}
    iamRoleStatements:
      - Effect: "Allow"
        Action:
          - dynamodb:DeleteItem
        Resource:
          - !GetAtt SubscriberFollowingTable.Arn
      - Effect: "Allow"
        Action:
          - sqs:SendMessage
        Resource:
          - !GetAtt UpdateFollowingQueue.Arn
      - Effect: "Allow"
        Action:
          - sqs:SendMessage
        Resource:
          - !GetAtt UpdateFollowingBackoffQueue.Arn

  syncSubscriberFollowing-updateFoll:
    handler: ./src/endpoints/syncSubscriberFollowing/updateFollowing.handler
    events:
      - sqs:
          arn:
            Fn::GetAtt: [UpdateFollowingQueue, Arn]
          batchSize: 1
          maximumConcurrency: 2
    environment:
      BLUESKY_SERVICE_IDENTIFIER: ${self:custom.blueskyAuth.identifier}
      BLUESKY_SERVICE_PASSWORD: ${self:custom.blueskyAuth.password}
    iamRoleStatementsName: ${self:service}-${self:provider.stage}-syncSubscriberFoll-foll-${self:provider.region}
    iamRoleStatements:
      - Effect: "Allow"
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource:
          - !GetAtt SubscriberFollowingTable.Arn

resources:
  Resources:
    SyncSubscriberQueueTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.syncSubscriberQueueTable}
        AttributeDefinitions:
          - AttributeName: subscriberDid
            AttributeType: S
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: subscriberDid
            KeyType: HASH
        StreamSpecification:
          StreamViewType: NEW_IMAGE

    SubscriberFollowingTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.subscriberFollowingTable}
        AttributeDefinitions:
          - AttributeName: subscriberDid
            AttributeType: S
          - AttributeName: qualifier
            AttributeType: S
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: subscriberDid
            KeyType: HASH
          - AttributeName: qualifier
            KeyType: RANGE
        StreamSpecification:
          StreamViewType: NEW_IMAGE

    MuteWordsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.muteWordsTable}
        AttributeDefinitions:
          - AttributeName: subscriberDid
            AttributeType: S
          - AttributeName: muteWord
            AttributeType: S
        BillingMode: PAY_PER_REQUEST
        KeySchema:
          - AttributeName: subscriberDid
            KeyType: HASH
          - AttributeName: muteWord
            KeyType: RANGE

    UpdateFollowingQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.updateFollowingQueue}
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt UpdateFollowingQueueDLQ.Arn
          maxReceiveCount: 5

    UpdateFollowingBackoffQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.updateFollowingBackoffQueue}
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt UpdateFollowingQueueDLQ.Arn
          maxReceiveCount: 5
    
    UpdateFollowingQueueDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.updateFollowingQueueDLQ}
        RedriveAllowPolicy:
          redrivePermission: allowAll